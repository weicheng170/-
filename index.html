<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>盒中氣體分子模擬</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; }
  canvas { border: 1px solid black; }
  .controls { margin-top: 10px; }
</style>
</head>
<body>
<h2>盒中氣體分子模擬</h2>
<canvas id="boxCanvas" width="500" height="500"></canvas>
<canvas id="chartCanvas" width="500" height="300"></canvas>

<div class="controls">
  <label>粒子數 N: <input type="range" id="sliderN" min="10" max="200" value="50"></label>
  <span id="valN">50</span><br>
  <label>溫度 T: <input type="range" id="sliderT" min="50" max="500" value="200"></label>
  <span id="valT">200</span><br>
  <label>體積 V (盒子大小): <input type="range" id="sliderV" min="200" max="500" value="400"></label>
  <span id="valV">400</span><br>
</div>

<script>
const canvas = document.getElementById("boxCanvas");
const ctx = canvas.getContext("2d");

let N = 50, T = 200, V = 400;
let particles = [];
let boxSize = V;
const particleRadius = 3;

function randomVelocity(T) {
  let v = Math.sqrt(T) * (Math.random() * 2 - 1);
  return v;
}

function initParticles() {
  particles = [];
  for (let i = 0; i < N; i++) {
    particles.push({
      x: Math.random() * boxSize,
      y: Math.random() * boxSize,
      vx: randomVelocity(T),
      vy: randomVelocity(T)
    });
  }
}

function updateParticles() {
  for (let p of particles) {
    p.x += p.vx;
    p.y += p.vy;

    // 撞牆
    if (p.x < 0 || p.x > boxSize) p.vx *= -1;
    if (p.y < 0 || p.y > boxSize) p.vy *= -1;
  }
}

function drawParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeRect(0, 0, boxSize, boxSize);
  ctx.fillStyle = "blue";
  for (let p of particles) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, particleRadius, 0, Math.PI * 2);
    ctx.fill();
  }
}

// ================= 分佈圖 =================
const chartCtx = document.getElementById("chartCanvas").getContext("2d");
const chart = new Chart(chartCtx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: '速度分佈',
      data: [],
      borderColor: 'blue',
      fill: false,
      tension: 0.2
    }]
  },
  options: {
    responsive: false,
    scales: {
      x: { title: { display: true, text: "速率" } },
      y: { title: { display: true, text: "粒子數" } }
    }
  }
});

function updateChart() {
  let speeds = particles.map(p => Math.sqrt(p.vx**2 + p.vy**2));

  let maxSpeed = Math.max(...speeds);
  let bins = 20;
  let step = maxSpeed / bins;
  let counts = new Array(bins).fill(0);

  for (let v of speeds) {
    let idx = Math.min(bins - 1, Math.floor(v / step));
    counts[idx]++;
  }

  let labels = counts.map((_, i) => (i * step).toFixed(1));
  chart.data.labels = labels;
  chart.data.datasets[0].data = counts;
  chart.update();

  // 計算平均, rms, 最大
  let avg = speeds.reduce((a,b)=>a+b,0) / speeds.length;
  let rms = Math.sqrt(speeds.reduce((a,b)=>a+b**2,0)/speeds.length);
  let max = Math.max(...speeds);

  ctx.fillStyle = "black";
  ctx.fillText(`平均速率=${avg.toFixed(2)}`, 10, boxSize+20);
  ctx.fillText(`均方根速率=${rms.toFixed(2)}`, 10, boxSize+40);
  ctx.fillText(`最大速率=${max.toFixed(2)}`, 10, boxSize+60);
}

function loop() {
  updateParticles();
  drawParticles();
  updateChart();
  requestAnimationFrame(loop);
}

// 控制器
document.getElementById("sliderN").oninput = e => {
  N = parseInt(e.target.value);
  document.getElementById("valN").textContent = N;
  initParticles();
};
document.getElementById("sliderT").oninput = e => {
  T = parseInt(e.target.value);
  document.getElementById("valT").textContent = T;
  initParticles();
};
document.getElementById("sliderV").oninput = e => {
  V = parseInt(e.target.value);
  boxSize = V;
  document.getElementById("valV").textContent = V;
  initParticles();
};

initParticles();
loop();
</script>
</body>
</html>
